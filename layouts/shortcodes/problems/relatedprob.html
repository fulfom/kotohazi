{{$id := .Get "id"}}
{{$pageid := .Get "pageid"}}
{{$pagepath := .Get "pagepath"}}
{{$categories := slice ""}}
{{$diff := 0}}
{{$same := slice 0}}

{{with $id}}
{{$this := index $.Site.Data.problems (sub $id 1)}}
{{$categories = $this.category}}
{{$diff = $this.difficulty.typicalStar}}
{{$same = slice (float $id)}}
{{end}}

{{with $pageid}}
{{range where $.Site.RegularPages ".File.UniqueID" $pageid}}
{{$categories = .Params.categories | default (slice "未分類")}}
{{$diff = .Params.level }}
{{range .Params.problems}}
{{$same = $same | append (. | float)}}
{{end}}
{{end}}{{end}}

{{if $pagepath}}
{{with .GetPage $pagepath}}
{{$categories = .Params.categories | default (slice "未分類")}}
{{$diff = .Params.level }}
{{range .Params.problems}}
{{$same = $same | append (. | float)}}
{{end}}
{{end}}{{end}}

{{$Arr := where $.Site.Data.problems "category" "intersect" $categories}}
{{with $diff}}
{{$diffArr := where $Arr "difficulty.typicalStar" "in" (slice (sub $diff 1) $diff (add $diff 1))}}
{{if gt (len $diffArr) 3 }}{{$Arr = $diffArr}}{{end}}
{{end}}

<div class="row">
{{range first 3 (shuffle (where $Arr "id" "not in" $same))}}
{{$prob := .}}
{{$venue := index $prob "venue"}}
{{$venuedetail := index $prob "venuedetail"}}
{{$year := index $prob "year"}}
{{$team := index $prob "team"}}
{{$number := index $prob "number"}}
{{$title := index $prob "title"}}
{{$titlejp := index $prob "titlejp"}}
{{$link := index $prob "link"}}
{{$topic := index $prob "topic"}}
{{$author := index $prob "author"}}
{{$category := index $prob "category"}}
{{$probcorrection := index $prob "probcorrection"}}
{{$solcorrection := index $prob "solcorrection"}}
{{$explanationlinks := index $prob "explanationlinks"}}
{{$difficulty := index $prob "difficulty"}}
{{$diffeach := index $prob "diffeach"}}
{{$namedyear := cond (lt $year 0) (index $.Site.Params.namedyear $year) $year}}
{{$detailpath := slice "problems" ((index $.Site.Params.venuedetail $venue | default $venue ) | urlize)}}
{{with $venuedetail}}{{$detailpath = $detailpath | append (. | urlize)}}{{end}}
{{with $namedyear}}{{$detailpath = $detailpath | append (. | urlize)}}{{end}}
{{$teamnum := slice "" }}
{{with $team}}{{$teamnum = slice $team $number}}
{{else}}{{$teamnum = slice $number}}
{{end}}
{{$detailpath = $detailpath | append ((delimit $teamnum "-") | urlize)}}
<div class="col-md-6 col-lg-4 mb-2">
<div class="card">
    <div class="card-body">
        <div class="d-flex">
            <h6 class="card-subtitle mb-2 text-muted mr-auto">{{$venuedetail | default $venue}}{{with $namedyear}}{{.}}{{end}}-{{with $team}}{{.}}-{{end}}{{$number}}</h6>
            {{with $probcorrection}}<h6 class="card-subtitle mb-2 text-muted"><a class="text-muted" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="問題訂正" data-content="{{.}}"><i class="fas fa-exclamation-circle fa-fw"></i></a></h6>{{end}}
            {{with $solcorrection}}<h6 class="card-subtitle mb-2 text-muted"><a class="text-muted" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="解答訂正" data-content="解答の訂正あり"><i class="fas fa-exclamation-circle fa-fw"></i></a></h6>{{end}}
            {{with $explanationlinks}}<h6 class="card-subtitle mb-2 text-muted"><a class="text-muted" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="詳しい解説" data-html="true" data-content="{{range $explanationlinks}}{{$url := .}}{{ $jsonData := getJSON $.Page.Site.Params.OgpApiEndpoint $url }}{{ $title := $jsonData.title }}{{ $description := $jsonData.description }}{{ $image := $jsonData.image }}{{ $urlInfo := urls.Parse $url }}{{ $host := printf "%s://%s" $urlInfo.Scheme $urlInfo.Host }}{{ $prefix := "https://www.google.com/s2/favicons?domain=" }}{{ $favicon := printf "%s%s" $prefix $urlInfo.Host }}<div class=&#34;card web-card d-flex flex-row mb-3&#34;><a href=&#34;{{ $url }}&#34; target=&#34;_blank&#34;></a><div class=&#34;thumb&#34;><img src=&#34;{{ $image }}&#34; alt=&#34;Card image cap&#34;></div><div class=&#34;card-body p-2&#34;><div class=&#34;d-flex&#34;><a href=&#34;{{ $host }}&#34; target=&#34;_blank&#34;><img src=&#34;{{ $favicon }}&#34; alt=&#34;&#34; class=&#34;favicon&#34;></a><h5 class=&#34;card-title ml-1 mb-1&#34;>{{$title}}</h5></div><p class=&#34;card-text text-muted&#34;>{{$description}}</p></div></div>{{end}}"><i class="fas fa-chalkboard-teacher fa-fw"></i></a></h6>{{end}}
        </div>
        {{with $titlejp}}<h6 class="card-subtitle mb-2 text-muted">{{$title}}</h6>{{end}}
        <h5 class="card-title">{{with $titlejp}}{{.}}{{else}}{{$title}}{{end}}</h5>
        <h6 class="card-subtitle mb-2 text-muted"><a class="text-muted" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="難易度の評定" data-content="{{range $diffeach}}{{.diff}} by {{.name}}; {{end}}">{{index (index $.Site.Params.diffstar "value") (($difficulty).typicalStar|int) |safeHTML}}{{($difficulty).typical}}</a> {{range $category}}{{if hasPrefix . "!"}}{{else}}<span class="tag m-1 unmot">{{.}}</span>{{end}}{{end}}</h6>
        <a href="{{$link}}" class="card-link" target="_blank">問題</a>
        <a href="/{{path.Join $detailpath }}" class="card-link">詳細</a>
    </div>
</div>
</div>
{{end}}
</div>